{
 "actions": [],
 "allow_rename": 1,
 "creation": "2026-01-27 11:00:00.000000",
 "doctype": "Client Script",
 "dt": "Opportunity",
 "enabled": 1,
 "modified": "2026-01-27 11:00:00.000000",
 "modified_by": "Administrator",
 "name": "Opportunity Nextcloud Button",
 "owner": "Administrator",
 "script": "frappe.ui.form.on('Opportunity', {\n\trefresh: function(frm) {\n\t\t// Only show button if opportunity is saved (has a name)\n\t\tif (frm.doc.name && !frm.doc.__islocal) {\n\t\t\t// Add custom button\n\t\t\tfrm.add_custom_button(__('Create Nextcloud Folder'), function() {\n\t\t\t\tcreate_nextcloud_folder(frm);\n\t\t\t}, __('Actions'));\n\t\t}\n\t\t\n\t\t// Listen for realtime notifications\n\t\tfrappe.realtime.on('nextcloud_folder_created', function(data) {\n\t\t\tif (data.success) {\n\t\t\t\tfrappe.show_alert({\n\t\t\t\t\tmessage: __('Nextcloud folder created successfully'),\n\t\t\t\t\tindicator: 'green'\n\t\t\t}, 5);\n\t\t\t\t// Reload the form to show the new comment\n\t\t\t\tfrm.reload_doc();\n\t\t\t} else {\n\t\t\t\tfrappe.show_alert({\n\t\t\t\t\tmessage: data.error || __('Failed to create folder'),\n\t\t\t\t\tindicator: 'red'\n\t\t\t}, 10);\n\t\t\t}\n\t\t});\n\t}\n});\n\nfunction create_nextcloud_folder(frm) {\n\t// Show immediate feedback - NO loading indicator\n\tfrappe.show_alert({\n\t\tmessage: __('Folder creation started in background. You will be notified when complete.'),\n\t\tindicator: 'blue'\n\t}, 5);\n\t\n\t// Use XMLHttpRequest for TRUE fire-and-forget (no UI blocking at all)\n\tvar xhr = new XMLHttpRequest();\n\txhr.open('POST', '/api/method/nextcloud_integration.hooks.create_nextcloud_folder_manual', true);\n\txhr.setRequestHeader('Content-Type', 'application/json');\n\txhr.setRequestHeader('X-Frappe-CSRF-Token', frappe.csrf_token);\n\t\n\t// Very short timeout - just to trigger the job, don't wait for response\n\txhr.timeout = 3000; // 3 seconds max to start the job\n\t\n\t// Send request (fire and forget)\n\txhr.send(JSON.stringify({\n\t\targs: {\n\t\t\topportunity_name: frm.doc.name\n\t\t}\n\t}));\n\t\n\t// Optional: Handle quick response (but don't block)\n\txhr.onload = function() {\n\t\tif (xhr.status === 200) {\n\t\t\ttry {\n\t\t\t\tvar response = JSON.parse(xhr.responseText);\n\t\t\t\tif (response.message && !response.message.success) {\n\t\t\t\t\tfrappe.show_alert({\n\t\t\t\t\t\tmessage: response.message.error || __('Failed to start folder creation'),\n\t\t\t\t\t\tindicator: 'red'\n\t\t\t\t\t}, 10);\n\t\t\t\t}\n\t\t\t} catch(e) {\n\t\t\t\t// Ignore parse errors - job might still be queued\n\t\t\t}\n\t\t}\n\t};\n\t\n\txhr.ontimeout = function() {\n\t\t// Timeout is OK - job is probably queued\n\t\t// User will get notification when done\n\t};\n\t\n\txhr.onerror = function() {\n\t\t// Error is OK - job might still be queued\n\t\tfrappe.show_alert({\n\t\t\tmessage: __('Note: Please check if folder was created. Connection may be slow.'),\n\t\t\tindicator: 'orange'\n\t\t}, 5);\n\t};\n}",
 "view": "Form",
 "module": "Nextcloud Integration"
}
